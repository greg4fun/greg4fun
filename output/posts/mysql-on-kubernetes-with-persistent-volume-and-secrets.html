<!DOCTYPE html>
<html prefix="        og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Mysql on kubernetes with persistent volume and secrets | Greg's Tech Notes</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="http://stencel.io/posts/mysql-on-kubernetes-with-persistent-volume-and-secrets.html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Greg Stencel">
<link rel="prev" href="kuberenetes-nfs-persistent-volume.html" title="Kuberenetes NFS persistent volume" type="text/html">
<meta property="og:site_name" content="Greg's Tech Notes">
<meta property="og:title" content="Mysql on kubernetes with persistent volume and secrets">
<meta property="og:url" content="http://stencel.io/posts/mysql-on-kubernetes-with-persistent-volume-and-secrets.html">
<meta property="og:description" content='Volumes

Persistent storage with NFS
In this example I have created nfs share "PersistentVolume" on my qnap NAS which IP is 192.168.1.11
Create persistentVolume.yml
apiVersion: v1
kind: PersistentVolu'>
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-06-28T08:50:51Z">
</head>
<body>
    <a href="#page-content" class="sr-only sr-only-focusable">Skip to main content</a>
    
    <section class="social"><ul>
<li><p style="color:#fff;font-size:3em;">stencel.io</p></li>
        <li><p style="color:#fff;font-size:2em;">greg's tech notes</p></li>
            <li>
                <a href="http://stencel.io/">
                    <img src="../images/aboutme.png" alt="Greg's Tech Notes" id="logo"></a>
            </li>
        
            <li><a href="../index.html" title="Home"><i class="fa fa-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="fa fa-folder-open"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="fa fa-tags"></i></a></li>
            <li><a href="https://www.linkedin.com/in/gregstencel/" title="My Linkedin"><i class="fab fa-linkedin"></i></a></li>
            <li><a href="https://github.com/greg4fun" title="My Github"><i class="fab fa-github"></i></a></li>
    
    

        </ul></section><section class="page-content"><div class="content" rel="main">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Mysql on kubernetes with persistent volume and secrets</a></h1>

        <div class="metadata">
            <p class="dateline"><a href="#" rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2020-06-28T08:50:51Z" itemprop="datePublished" title="2020-06-28 08:50">2020-06-28 08:50</time></a></p>
            <p class="byline author vcard"> <i class="fa fa-user"></i> <span class="byline-name fn" itemprop="author">
                    Greg Stencel
            </span></p>
                <p class="commentline"><i class="far fa-comment"></i>
        
    <a href="mysql-on-kubernetes-with-persistent-volume-and-secrets.html#disqus_thread" data-disqus-identifier="cache/posts/mysql-on-kubernetes-with-persistent-volume-and-secrets.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="mysql-on-kubernetes-with-persistent-volume-and-secrets.rst" class="sourcelink"><i class="fa fa-file-code"></i> Source</a></p>

            

            

        </div>
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="section" id="volumes">
<h2>Volumes</h2>
<div class="section" id="persistent-storage-with-nfs">
<h3>Persistent storage with NFS</h3>
<p>In this example I have created nfs share "PersistentVolume" on my qnap NAS which IP is 192.168.1.11
Create persistentVolume.yml</p>
<pre class="code yaml"><a name="rest_code_3131cf119fcc4ad0817027d6698e5917-1"></a><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-2"></a><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-4"></a>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pv0001</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-5"></a><span class="nt">spec</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-6"></a>  <span class="nt">capacity</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-7"></a>    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100Gi</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-8"></a>  <span class="nt">accessModes</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-9"></a>  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-10"></a>  <span class="nt">mountOptions</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-11"></a>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nfsvers=4.1</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-12"></a>  <span class="nt">nfs</span><span class="p">:</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-13"></a>    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/PersistentVolume/pv0001</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-14"></a>    <span class="nt">server</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.11</span>
<a name="rest_code_3131cf119fcc4ad0817027d6698e5917-15"></a>  <span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
</pre>
<p>Create persistentVolumeClaim.yml</p>
<pre class="code yaml"><a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-1"></a><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-2"></a><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-4"></a>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-pv-claim</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-5"></a><span class="nt">spec</span><span class="p">:</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-6"></a>  <span class="nt">accessModes</span><span class="p">:</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-7"></a>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-8"></a>  <span class="nt">resources</span><span class="p">:</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-9"></a>    <span class="nt">requests</span><span class="p">:</span>
<a name="rest_code_86bcdd9ec1ab4de193e973b1442280cf-10"></a>      <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</pre>
</div>
</div>
<div class="section" id="secrets">
<h2>Secrets</h2>
<p>The configuration of your containers should be stored in separate place to guarantee mobility (it shouldnt be hardcoded ) neither should it be stored in database
The best approach is to store your configuration in environment variables for docker for instance you can store it in env files which are gitignored or env vars which you need to set during container startup.
In kubernetes you have option to store all configuration like usernames, passwords, API urls etc in configmaps and secrets.
Passwords shouldnt be stored in configmaps though as it is stored there in plain text.So the best choice for passwords is secrets which stores data in base64.</p>
<p>Create password and user and db name and encode it with base64</p>
<pre class="code bash"><a name="rest_code_c490c144533643a89ab0fd997c09358f-1"></a><span class="nb">echo</span> -n <span class="s2">"MyPassword"</span> <span class="p">|</span> base64 <span class="c1">#TXlQYXNzd29yZA==</span>
<a name="rest_code_c490c144533643a89ab0fd997c09358f-2"></a><span class="nb">echo</span> -n <span class="s2">"django"</span> <span class="p">|</span> base64  <span class="c1"># ZGphbmdv</span>
<a name="rest_code_c490c144533643a89ab0fd997c09358f-3"></a><span class="nb">echo</span> -n <span class="s2">"kubernetes_test"</span> <span class="p">|</span> base64 <span class="c1"># a3ViZXJuZXRlc190ZXN0</span>
</pre>
<p>Apply above results to secret.yml</p>
<pre class="code yaml"><a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-1"></a><span class="nn">---</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-2"></a><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-3"></a><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-5"></a>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-secrets</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-6"></a><span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-7"></a><span class="nt">data</span><span class="p">:</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-8"></a>  <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TXlQYXNzd29yZA==</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-9"></a>  <span class="nt">MYSQL_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ZGphbmdv</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-10"></a>  <span class="nt">MYSQL_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ZGphbmdv</span>
<a name="rest_code_b6f1b541d21f46b59babb961380fb1ec-11"></a>  <span class="nt">MYSQL_DATABASE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">a3ViZXJuZXRlc190ZXN0</span>
</pre>
<p>On your cluster create secrets.yml</p>
<pre class="code bash"><a name="rest_code_0dc673c01cb3481ab0530a599c68ba32-1"></a>kubectl create -f secrets.yml
</pre>
<p>Now having persistent volumeclain and secrets we can write mysql deployment file</p>
<p>deployment.yml</p>
<pre class="code yaml"><a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-1"></a><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-2"></a><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-4"></a>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-deployment</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-5"></a>  <span class="nt">labels</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-6"></a>    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-7"></a><span class="nt">spec</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-8"></a>  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-9"></a>  <span class="nt">selector</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-10"></a>    <span class="nt">matchLabels</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-11"></a>      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-12"></a>  <span class="nt">template</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-13"></a>    <span class="nt">metadata</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-14"></a>      <span class="nt">labels</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-15"></a>        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-16"></a>    <span class="nt">spec</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-17"></a>      <span class="nt">containers</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-18"></a>        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-19"></a>          <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql:5.7</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-20"></a>          <span class="nt">ports</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-21"></a>            <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-22"></a>          <span class="nt">volumeMounts</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-23"></a>            <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="s">"/var/lib/mysql"</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-24"></a>              <span class="nt">subPath</span><span class="p">:</span> <span class="s">"mysql"</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-25"></a>              <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-data</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-26"></a>          <span class="nt">env</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-27"></a>            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-28"></a>              <span class="nt">valueFrom</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-29"></a>                <span class="nt">secretKeyRef</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-30"></a>                  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-secrets</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-31"></a>                  <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-32"></a>            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_USER</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-33"></a>              <span class="nt">valueFrom</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-34"></a>                <span class="nt">secretKeyRef</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-35"></a>                  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-secrets</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-36"></a>                  <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_USER</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-37"></a>            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_PASSWORD</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-38"></a>              <span class="nt">valueFrom</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-39"></a>                <span class="nt">secretKeyRef</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-40"></a>                  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-secrets</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-41"></a>                  <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_PASSWORD</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-42"></a>            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-43"></a>              <span class="nt">valueFrom</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-44"></a>                <span class="nt">secretKeyRef</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-45"></a>                  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-secrets</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-46"></a>                  <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-47"></a>      <span class="nt">volumes</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-48"></a>        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-data</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-49"></a>          <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<a name="rest_code_c8e863eb9a984eb1bddb84d6908697c6-50"></a>            <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql-pv-claim</span>
</pre>
<pre class="code bash"><a name="rest_code_330234526cf24823b22a63479224f08b-1"></a>kubectl apply -f deployment.yml
</pre>
<p>Now we can check if our deployment was successful:</p>
<pre class="code bash"><a name="rest_code_d91fb7aa3f544c4a871a0749c51d5faa-1"></a>kubectl get deployments
<a name="rest_code_d91fb7aa3f544c4a871a0749c51d5faa-2"></a>
<a name="rest_code_d91fb7aa3f544c4a871a0749c51d5faa-3"></a>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
<a name="rest_code_d91fb7aa3f544c4a871a0749c51d5faa-4"></a>mysql-deployment   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           66m
</pre>
<p>If somethings wrong you can always investigate with describe or logs</p>
<pre class="code bash"><a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-1"></a>kubectl describe deployment mysql-deployment
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-2"></a>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-3"></a>Name:                   mysql-deployment
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-4"></a>Namespace:              default
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-5"></a>CreationTimestamp:      Sun, <span class="m">28</span> Jun <span class="m">2020</span> <span class="m">17</span>:02:00 +0000
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-6"></a>Labels:                 <span class="nv">app</span><span class="o">=</span>mysql
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-7"></a>Annotations:            deployment.kubernetes.io/revision: <span class="m">1</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-8"></a>Selector:               <span class="nv">app</span><span class="o">=</span>mysql
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-9"></a>Replicas:               <span class="m">1</span> desired <span class="p">|</span> <span class="m">1</span> updated <span class="p">|</span> <span class="m">1</span> total <span class="p">|</span> <span class="m">1</span> available <span class="p">|</span> <span class="m">0</span> unavailable
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-10"></a>StrategyType:           RollingUpdate
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-11"></a>MinReadySeconds:        <span class="m">0</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-12"></a>RollingUpdateStrategy:  <span class="m">25</span>% max unavailable, <span class="m">25</span>% max surge
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-13"></a>Pod Template:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-14"></a>Labels:  <span class="nv">app</span><span class="o">=</span>mysql
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-15"></a>Containers:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-16"></a>mysql:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-17"></a>    Image:      mysql:5.7
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-18"></a>    Port:       <span class="m">3306</span>/TCP
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-19"></a>    Host Port:  <span class="m">0</span>/TCP
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-20"></a>    Environment:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-21"></a>    MYSQL_ROOT_PASSWORD:  &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_ROOT_PASSWORD'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;  Optional: <span class="nb">false</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-22"></a>    MYSQL_USER:           &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_USER'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;           Optional: <span class="nb">false</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-23"></a>    MYSQL_PASSWORD:       &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_PASSWORD'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;       Optional: <span class="nb">false</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-24"></a>    MYSQL_DATABASE:       &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_DATABASE'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;       Optional: <span class="nb">false</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-25"></a>    Mounts:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-26"></a>    /var/lib/mysql from mysql-data <span class="o">(</span>rw,path<span class="o">=</span><span class="s2">"mysql"</span><span class="o">)</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-27"></a>Volumes:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-28"></a>mysql-data:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-29"></a>    Type:       PersistentVolumeClaim <span class="o">(</span>a reference to a PersistentVolumeClaim in the same namespace<span class="o">)</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-30"></a>    ClaimName:  mysql-pv-claim
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-31"></a>    ReadOnly:   <span class="nb">false</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-32"></a>Conditions:
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-33"></a>Type           Status  Reason
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-34"></a>----           ------  ------
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-35"></a>Available      True    MinimumReplicasAvailable
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-36"></a>Progressing    True    NewReplicaSetAvailable
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-37"></a>OldReplicaSets:  &lt;none&gt;
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-38"></a>NewReplicaSet:   mysql-deployment-579b8bb767 <span class="o">(</span><span class="m">1</span>/1 replicas created<span class="o">)</span>
<a name="rest_code_2892dfa9635740b6a519e2d37b6c5662-39"></a>Events:          &lt;none&gt;
</pre>
<p>Or investigate pods</p>
<pre class="code bash"><a name="rest_code_8066f279017d44589d0770affb8f2fe7-1"></a>kubectl get pods
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-2"></a>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-3"></a>NAME                                READY   STATUS    RESTARTS   AGE
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-4"></a>mysql-deployment-579b8bb767-mk5jx   <span class="m">1</span>/1     Running   <span class="m">0</span>          69m
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-5"></a>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-6"></a>kubectl describe pod mysql-deployment-579b8bb767-mk5jx
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-7"></a>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-8"></a>Name:         mysql-deployment-579b8bb767-mk5jx
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-9"></a>Namespace:    default
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-10"></a>Priority:     <span class="m">0</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-11"></a>Node:         worker4/192.168.50.15
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-12"></a>Start Time:   Sun, <span class="m">28</span> Jun <span class="m">2020</span> <span class="m">17</span>:02:00 +0000
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-13"></a>Labels:       <span class="nv">app</span><span class="o">=</span>mysql
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-14"></a>            pod-template-hash<span class="o">=</span>579b8bb767
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-15"></a>Annotations:  cni.projectcalico.org/podIP: <span class="m">192</span>.168.199.131/32
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-16"></a>Status:       Running
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-17"></a>IP:           <span class="m">192</span>.168.199.131
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-18"></a>IPs:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-19"></a>IP:           <span class="m">192</span>.168.199.131
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-20"></a>Controlled By:  ReplicaSet/mysql-deployment-579b8bb767
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-21"></a>Containers:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-22"></a>mysql:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-23"></a>    Container ID:   docker://b755c731e9b72812040d62315a2499d05cdaa6b8425e6b357fa19f1e9d6aed2c
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-24"></a>    Image:          mysql:5.7
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-25"></a>    Image ID:       docker-pullable://mysql@sha256:32f9d9a069f7a735e28fd44ea944d53c61f990ba71460c5c183e610854ca4854
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-26"></a>    Port:           <span class="m">3306</span>/TCP
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-27"></a>    Host Port:      <span class="m">0</span>/TCP
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-28"></a>    State:          Running
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-29"></a>    Started:      Sun, <span class="m">28</span> Jun <span class="m">2020</span> <span class="m">17</span>:02:02 +0000
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-30"></a>    Ready:          True
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-31"></a>    Restart Count:  <span class="m">0</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-32"></a>    Environment:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-33"></a>    MYSQL_ROOT_PASSWORD:  &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_ROOT_PASSWORD'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;  Optional: <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-34"></a>    MYSQL_USER:           &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_USER'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;           Optional: <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-35"></a>    MYSQL_PASSWORD:       &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_PASSWORD'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;       Optional: <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-36"></a>    MYSQL_DATABASE:       &lt;<span class="nb">set</span> to the key <span class="s1">'MYSQL_DATABASE'</span> in secret <span class="s1">'mysql-secrets'</span>&gt;       Optional: <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-37"></a>    Mounts:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-38"></a>    /var/lib/mysql from mysql-data <span class="o">(</span>rw,path<span class="o">=</span><span class="s2">"mysql"</span><span class="o">)</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-39"></a>    /var/run/secrets/kubernetes.io/serviceaccount from default-token-4wtnw <span class="o">(</span>ro<span class="o">)</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-40"></a>Conditions:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-41"></a>Type              Status
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-42"></a>Initialized       True
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-43"></a>Ready             True
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-44"></a>ContainersReady   True
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-45"></a>PodScheduled      True
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-46"></a>Volumes:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-47"></a>mysql-data:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-48"></a>    Type:       PersistentVolumeClaim <span class="o">(</span>a reference to a PersistentVolumeClaim in the same namespace<span class="o">)</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-49"></a>    ClaimName:  mysql-pv-claim
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-50"></a>    ReadOnly:   <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-51"></a>default-token-4wtnw:
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-52"></a>    Type:        Secret <span class="o">(</span>a volume populated by a Secret<span class="o">)</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-53"></a>    SecretName:  default-token-4wtnw
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-54"></a>    Optional:    <span class="nb">false</span>
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-55"></a>QoS Class:       BestEffort
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-56"></a>Node-Selectors:  &lt;none&gt;
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-57"></a>Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="k">for</span> 300s
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-58"></a>                node.kubernetes.io/unreachable:NoExecute <span class="k">for</span> 300s
<a name="rest_code_8066f279017d44589d0770affb8f2fe7-59"></a>Events:          &lt;none&gt;
</pre>
<p>Or logs from pod</p>
<pre class="code bash"><a name="rest_code_52bb962148f7427bafc3f36d70958b5b-1"></a>kubectl logs mysql-deployment-579b8bb767-mk5jx
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-2"></a>
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-3"></a><span class="m">2020</span>-06-28T17:02:13.695295Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span> IPv6 is available.
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-4"></a><span class="m">2020</span>-06-28T17:02:13.695350Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span>   - <span class="s1">'::'</span> resolves to <span class="s1">'::'</span><span class="p">;</span>
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-5"></a><span class="m">2020</span>-06-28T17:02:13.695392Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span> Server socket created on IP: <span class="s1">'::'</span>.
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-6"></a><span class="m">2020</span>-06-28T17:02:13.695906Z <span class="m">0</span> <span class="o">[</span>Warning<span class="o">]</span> Insecure configuration <span class="k">for</span> --pid-file: Location <span class="s1">'/var/run/mysqld'</span> in the path is accessible to all OS users. Consider choosing a different directory.
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-7"></a><span class="m">2020</span>-06-28T17:02:13.703856Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span> InnoDB: Buffer pool<span class="o">(</span>s<span class="o">)</span> load completed at <span class="m">200628</span> <span class="m">17</span>:02:13
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-8"></a><span class="m">2020</span>-06-28T17:02:13.746239Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span> Event Scheduler: Loaded <span class="m">0</span> events
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-9"></a><span class="m">2020</span>-06-28T17:02:13.746461Z <span class="m">0</span> <span class="o">[</span>Note<span class="o">]</span> mysqld: ready <span class="k">for</span> connections.
<a name="rest_code_52bb962148f7427bafc3f36d70958b5b-10"></a>Version: <span class="s1">'5.7.30'</span>  socket: <span class="s1">'/var/run/mysqld/mysqld.sock'</span>  port: <span class="m">3306</span>  MySQL Community Server <span class="o">(</span>GPL<span class="o">)</span>
</pre>
<p>Where we can see our mysql server is up and running</p>
<p>We can now test if our secrets were applied by running exact same exec syntax as in docker
NEVER PROVIDE PASSWORD IN COMMAND LINE THIS IS JUST FOR DEMONSTRATION PURPOSES if you do just -p you will be prompted
for password</p>
<pre class="code bash"><a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-1"></a>kubectl <span class="nb">exec</span> -it mysql-deployment-579b8bb767-mk5jx -- mysql -u root -pMyPassword
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-2"></a>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-3"></a>mysql&gt; show databases<span class="p">;</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-4"></a>+--------------------+
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-5"></a><span class="p">|</span> Database           <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-6"></a>+--------------------+
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-7"></a><span class="p">|</span> information_schema <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-8"></a><span class="p">|</span> kubernetes_test    <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-9"></a><span class="p">|</span> mysql              <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-10"></a><span class="p">|</span> performance_schema <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-11"></a><span class="p">|</span> sys                <span class="p">|</span>
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-12"></a>+--------------------+
<a name="rest_code_5f368737f9c442c2ba58de0e25f04c69-13"></a><span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.02 sec<span class="o">)</span>
</pre>
<p>We can see initial db kubernetes_test was created
also lets try to log in to it with user and pass set up</p>
<pre class="code bash"><a name="rest_code_5c70d24a307b4b0496e39147092ce4e9-1"></a>kubectl <span class="nb">exec</span> -it mysql-deployment-579b8bb767-mk5jx -- mysql -u django -pdjango kubernetes_test
<a name="rest_code_5c70d24a307b4b0496e39147092ce4e9-2"></a>
<a name="rest_code_5c70d24a307b4b0496e39147092ce4e9-3"></a>Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for</span> help. Type <span class="s1">'\c'</span> to clear the current input statement.
<a name="rest_code_5c70d24a307b4b0496e39147092ce4e9-4"></a>
<a name="rest_code_5c70d24a307b4b0496e39147092ce4e9-5"></a>mysql&gt;
</pre>
<p>Everything works as expected!!</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="kuberenetes-nfs-persistent-volume.html" rel="prev" title="Kuberenetes NFS persistent volume">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="stencel",
            disqus_url="http://stencel.io/posts/mysql-on-kubernetes-with-persistent-volume-and-secrets.html",
        disqus_title="Mysql on kubernetes with persistent volume and secrets",
        disqus_identifier="cache/posts/mysql-on-kubernetes-with-persistent-volume-and-secrets.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="stencel";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2020         <a href="mailto:gstencel@gmail.com">Greg Stencel</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50641127-1', 'stencel.io');
  ga('send', 'pageview');

</script><script type="text/javascript" src="../assets/js/tipuesearch_set.js"></script><script type="text/javascript" src="../assets/js/tipuesearch.js"></script><script type="text/javascript">
$(document).ready(function() {
     $('#tipue_search_input').tipuesearch({
         'mode': 'json',
         'contentLocation': '/assets/js/tipuesearch_content.json',
         'showUrl': false
     });
});
</script>
</body>
</html>
